---
title: "model_fitting"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{model_fitting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidyverse)
library(bioinactivation2)
```

## The `fit_inactivation()` function

AA

## Fitting primary models

```{r}
data("inactivation_experiment")

make_guess_primary(inactivation_experiment, 
                   "Geeraerd", formula = logN ~ t)


check_inactivation_guess("primary", 
                         inactivation_experiment, 
                         "Geeraerd",
                         make_guess_primary(inactivation_experiment,
                                            "Geeraerd", 
                                            formula = logN ~ t),
                         formula = logN ~ t
                         )


# guess <- list(logN0 = 8, logD = 2)
known <- list()

aa <- fit_inactivation("primary", 
                       inactivation_experiment, 
                       "Bigelow",
                       make_guess_primary(inactivation_experiment, 
                                          "Bigelow", formula = logN ~ t), 
                       known,
                       formula = logN ~ t)
coef(aa)
summary(aa)
plot(aa)
```

```{r}
## with bounds

fit_inactivation("primary", 
                       inactivation_experiment, 
                       "Bigelow",
                       guess = c(logN0 = 8, logD = 0.3), 
                       # known = c(),
                 lower = c(logN0 = 7, logD = .1),
                 upper = c(logN0 = 9, logD = .4),
                       formula = logN ~ t) %>% 
  summary()
```
## Other algorithm 

```{r}

aa <- fit_inactivation("primary", 
                       inactivation_experiment, 
                       "Bigelow",
                       make_guess_primary(inactivation_experiment, 
                                          "Bigelow", formula = logN ~ t), 
                       algorithm = "MCMC",
                       formula = logN ~ t,
                       niter = 100,
                       burninlength = 20)
coef(aa)
summary(aa)
plot(aa)
```



```{r}
guess <- list(logN0 = 8, logD = 2)
known <- list()

aa <- fit_inactivation("primary", d, "Bigelow", guess, known)
summary(aa)
plot(aa)
```

```{r}
guess <- list(logN0 = 8, delta = 1, p = 1)
known <- list()

aa <- fit_inactivation("primary", d, "Mafart", guess, known)
summary(aa)
plot(aa)
```

```{r}
fit_inactivation("primary", d, "Peleg",
                       make_guess_primary(d, "Peleg"), known = c()) %>%
  plot()
```


## Dynamic fitting

```{r}
data("dynamic_conditions")
data("dynamic_experiment")

sec_models <- list(
  list(par = "D",
       model = "Bigelow",
       depends_on = c("temp", "pH")
  )
)

guess <- c(logN0 = 7,
           D_temp_logz = .69,
           D_pH_z = 2,
           D_logref = 1
)

known <- c(D_temp_xref = 55,
           D_pH_xref = 7
           )


check_inactivation_guess("dynamic", 
                         dynamic_experiment,
                         primary_model_name = "Bigelow",
                         c(guess, known),
                         secondary_models = sec_models,
                         env_conditions = dynamic_conditions
                         )

aa <- fit_inactivation("dynamic", 
                 dynamic_experiment, 
                 "Bigelow",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = dynamic_conditions,
                 algorithm = "regression")

plot(aa)
summary(aa)


```

```{r}

## Bounds

fit_inactivation("dynamic", 
                 dynamic_experiment, 
                 "Bigelow",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = dynamic_conditions,
                 algorithm = "regression",
                 upper = c(logN0 = 8, D_temp_logz = 1, D_pH_z = 3, D_logref = 2),
                 lower = c(logN0 = 4, D_temp_logz = 0, D_pH_z = 1, D_logref = 0)
                 ) %>%
  summary()
```

```{r}
## Algorithm

aa <- fit_inactivation("dynamic", 
                 dynamic_experiment, 
                 "Bigelow",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = dynamic_conditions,
                 algorithm = "MCMC",
                 niter = 100,
                 burninlength = 50)

summary(aa)
plot(aa)

```

## One-step fit

```{r}

data("inactivation_onestep")

sec_models <- list(
  list(par = "delta",
       model = "Bigelow",
       depends_on = c("temp", "pH")
  ),
  list(par = "p",
       model = "Bigelow",
       depends_on = c()
  )
)

guess <- c(logN0 = 7,
           delta_temp_logz = .69,
           delta_pH_z = 2,
           delta_logref = 1,
           p_logref = 0
)

known <- c(delta_temp_xref = 55,
           delta_pH_xref = 7
           )


aa <- fit_inactivation("one-step", 
                 inactivation_onestep, 
                 "Mafart",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = env_conditions,
                 algorithm = "regression")

summary(aa)
plot(aa)
```

```{r}

## bounds

fit_inactivation("one-step", 
                 inactivation_onestep, 
                 "Mafart",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = env_conditions,
                 algorithm = "regression",
                 upper = c(logN0 = 8, delta_temp_logz = 1, delta_pH_z = 3,
                           delta_logref = 2, p_logref = 1),
                 lower = c(logN0 = 6, delta_temp_logz = -1, delta_pH_z = .5,
                           delta_logref = 0, p_logref = -1)
                 ) %>%
  summary()
```

```{r}
aa <- fit_inactivation("one-step", 
                 inactivation_onestep, 
                 "Mafart",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = env_conditions,
                 algorithm = "MCMC",
                 niter = 10)

summary(aa)
plot(aa)
```


## Fitting secondary models - the `fit_inactivation_secondary()` function

```{r}
##

data("inactivation_secondary")

make_guess_secondary(inactivation_secondary, "genBigelow", formula = delta ~ temp + pH)

check_secondary_guess(inactivation_secondary, "genBigelow", 
                      make_guess_secondary(inactivation_secondary, "genBigelow", 
                                           formula = delta ~ temp + pH),
                      formula = delta ~ temp + pH
                      )

guess <- c(temp_logz = .69,
           pH_z = 2,
           logref = 1
)

known <- c(temp_xref = 55,
           pH_xref = 7
)

aa <- fit_inactivation_secondary(inactivation_secondary,
                           "Bigelow",
                           guess = guess,
                           known = known,
                           formula = delta ~ temp + pH
)

coef(aa)
summary(aa)

check_secondary_guess(inactivation_secondary, "Bigelow", 
                      c(coef(aa), known),
                      formula = delta ~ temp + pH
                      )

predict(aa)
predict(aa, newdata = tibble(temp = c(55, 56), pH = c(7, 5)))
plot(aa)
plot(aa, type = 2)
```

```{r}
# bounds

guess <- c(temp_logz = .69,
           pH_z = 2,
           logref = 1
           )

upper <- c(temp_logz = .75,
           pH_z = 2.5,
           logref = 2
           )


lower <- c(temp_logz = .2,
           pH_z = 0,
           logref = 0
           )


aa <- fit_inactivation_secondary(inactivation_secondary,
                           "Bigelow",
                           guess = guess,
                           known = known,
                           formula = delta ~ temp + pH,
                           upper = upper,
                           lower = lower
)

summary(aa)
```

```{r}
## MCMC

aa <- fit_inactivation_secondary(inactivation_secondary,
                           "Bigelow",
                           guess = guess,
                           known = known,
                           formula = delta ~ temp + pH,
                           algorithm = "MCMC",
                           niter = 10
                           )

summary(aa)
```

## Global fitting

```{r}
primary_model <- list(model = "Bigelow", 
                      logN0 = 6
                      )

secondary_models <- list(
  list(par = "logD",
       model = "Bigelow",
       temp = c("xref" = 55, logz = .69),
       pH = c("xref" = 7, z = 5),
       ref = 1
  )
)

times <- seq(0, 10, length = 20)

e1 <- tibble(time = c(0, 5, 10),
                         temp = c(55, 60, 55),
                         pH = c(7, 7, 4))

e2 <- tibble(time = c(0, 5, 10),
             temp = c(60, 55, 60),
             pH = c(7, 7, 4))



p1 <- predict_inactivation(times, primary_model, environment = "dynamic",
                           secondary_models, e1) 

p2 <- predict_inactivation(times, primary_model, environment = "dynamic",
                           secondary_models, e2) 

plot(p1)
plot(p2)

d1 <- p1$simulation %>%
  mutate(logN = logN + rnorm(nrow(.), mean = 0, sd = .1)) %>%
  select(time, logN)

d2 <- p2$simulation %>%
  mutate(logN = logN + rnorm(nrow(.), mean = 0, sd = .1)) %>%
  select(time, logN)

d <- list(exp1 = d1, exp2 = d2)
env <- list(exp1 = e1, exp2 = e2)

####

sec_models <- list(
  list(par = "D",
       model = "Bigelow",
       depends_on = c("temp", "pH")
  )
)

guess <- c(logN0 = 7,
           D_temp_logz = .69,
           D_pH_z = 2,
           D_logref = 1
)

known <- c(D_temp_xref = 55,
           D_pH_xref = 7
           )


# check_inactivation_guess("dynamic", 
#                          d,
#                          primary_model_name = "Bigelow",
#                          c(guess, known),
#                          secondary_models = sec_models,
#                          env_conditions = env_conditions
#                          )

aa <- fit_inactivation("global", 
                 d, 
                 "Bigelow",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = env,
                 algorithm = "regression")

summary(aa)
```

```{r}
## bounds

guess <- c(logN0 = 7,
           D_temp_logz = .69,
           D_pH_z = 2,
           D_logref = 1
)

aa <- fit_inactivation("global", 
                 d, 
                 "Bigelow",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = env,
                 algorithm = "regression",
                 upper = c(logN0 = 8, D_temp_logz = .8, D_pH_z = 4, D_logref = 2),
                 lower = c(logN0 = 6, D_temp_logz = .3, D_pH_z = 2, D_logref = 0)
                 )

summary(aa)

```


## Two-steps fitting

```{r}


do_shit <- function(pH, temp) {
  
  times <- seq(0, 15, length = 15)
  primary_model <- list(model = "Mafart", logN0 = 7)
  
  env_conditions <- tibble(time = c(0, 10),
                           temp = c(temp),
                           pH = c(pH))
  
  secondary_models <- list(
    list(par = "logdelta",
         model = "genBigelow",
         temp = c("xref" = 55, logz = .69, n=1),
         pH = c("xref" = 7, z = 2, n=1),
         ref = 1
    ),
    list(par = "logp",
         model = "Bigelow",
         ref = .2
    )
  )
  
  predict_inactivation(times, primary_model, environment = "dynamic",
                       secondary_models, env_conditions)$simulation %>%
    mutate(logN = logN + rnorm(nrow(.), mean = 0, sd = .2))
  
}

conds <- expand.grid(pH = c(5, 6, 7),
            temp = c(55, 56, 57)) 

sims <- conds %>%
  mutate(i = row_number()) %>%
  split(.$i) %>%
  map(., ~ do_shit(.$pH, .$temp))

d <- conds %>%
  mutate(i = row_number()) %>%
  split(.$i) %>%
  map2_dfr(., sims,
           ~ bind_cols(.x, .y)
  ) %>%
  select(pH, temp, time, logN)

d %>%
  ggplot() + geom_point(aes(time, logN, colour = factor(temp))) + facet_wrap("pH")

##


primary_model <- list(model = "Mafart", 
                      logN0 = 7
)

sec_models <- list(
  list(par = "delta",
       model = "Bigelow",
       depends_on = c("temp", "pH")
  ),
  list(par = "p",
       model = "Bigelow",
       depends_on = c()
  )
)

guess <- c(logN0 = 7,
           delta_temp_logz = .69,
           delta_pH_z = 2,
           delta_logref = 1,
           p_logref = 0
)

known <- c(delta_temp_xref = 55,
           delta_pH_xref = 7
           )

aa <- fit_inactivation("two-steps", 
                 d, 
                 "Mafart",
                 guess, 
                 known, 
                 secondary_models = sec_models,
                 env_conditions = env_conditions,
                 algorithm = "regression")

coef(aa)
coef(aa, step = 1)
summary(aa)
summary(aa, step = 1)

```






